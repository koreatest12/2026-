name: Massive Data Generator & Push

on:
  workflow_dispatch: # 수동 실행
  push:
    branches: [ "main" ]

# 권한 설정 (필수)
permissions:
  contents: write

jobs:
  generate-and-push:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 대량 작업을 위해 타임아웃을 6시간으로 연장

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 전체 히스토리 가져오기 (충돌 방지)

      # ----------------------------------------------------------------
      # [1] 여기에 데이터 생성/수정 로직을 넣으세요 (기존 로직 유지)
      # 예: python generate_data.py 또는 npm run build 등
      # ----------------------------------------------------------------
      - name: Generate Massive Data
        run: |
          echo "데이터 생성 로직이 이곳에서 실행됩니다."
          # 실제 생성 명령어 입력 (예: node generator.js)

      # ----------------------------------------------------------------
      # [2] 대량 파일 처리용 Git 설정 및 커밋 (핵심 수정 부분)
      # ----------------------------------------------------------------
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Smart Batch Commit (Massive Files)
        shell: bash
        run: |
          # 배치 크기 설정 (한 번에 커밋할 파일 수)
          BATCH_SIZE=3000
          
          echo "🔵 대량 파일 감지 및 분할 커밋 시작..."
          
          # 변경(수정+추가)된 파일 목록 확보
          # git status는 메모리를 많이 쓰므로, find 명령어로 직접 파일 목록을 제어하거나
          # git status --porcelain을 사용하여 가볍게 처리
          
          while true; do
            # 변경된 파일 목록 상위 N개 가져오기
            git status --porcelain | head -n $BATCH_SIZE | awk '{print $2}' > batch_files.txt
            
            # 처리할 파일이 없으면 루프 종료
            if [ ! -s batch_files.txt ]; then
              echo "✅ 모든 파일 커밋 완료."
              break
            fi
            
            # 현재 배치 파일 개수 확인
            COUNT=$(wc -l < batch_files.txt)
            echo "🚀 Processing batch of $COUNT files..."
            
            # xargs를 사용하여 배치 파일을 스테이징 (로그 출력 없음)
            cat batch_files.txt | xargs git add
            
            # 커밋 수행 (타임스탬프 포함하여 충돌 방지)
            git commit -m "Auto-commit: Batch update of $COUNT files [$(date +%T)]"
            
            # (선택) 중간중간 푸시를 원하면 아래 주석 해제 (너무 잦은 푸시는 느릴 수 있음)
            # git push origin HEAD:main
          done

      # ----------------------------------------------------------------
      # [3] 최종 푸시 (한 번에 밀어넣기)
      # ----------------------------------------------------------------
      - name: Final Push
        if: success()
        run: |
          echo "🔵 GitHub 저장소로 푸시 중..."
          # 대량 푸시 시 타임아웃 방지를 위해 재시도 로직 포함
          git push origin HEAD:main || (git pull --rebase && git push origin HEAD:main)
