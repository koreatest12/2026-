name: Oracle Massive Generator & Push

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  generate-and-push:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 6ì‹œê°„ ì œí•œ

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # [1] ì˜¤ë¼í´ í…Œì´ë¸” ì¿¼ë¦¬ ëŒ€ëŸ‰ ìƒì„± (Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰)
      # ---------------------------------------------------------
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Generate Massive Oracle SQL Files
        run: |
          # íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¦‰ì„ì—ì„œ ìƒì„±í•˜ì—¬ ì‹¤í–‰ (ë³„ë„ íŒŒì¼ ê´€ë¦¬ ë¶ˆí•„ìš”)
          cat <<EOF > generate_oracle_ddl.py
          import os
          import random

          # ì„¤ì •: ìƒì„±í•  í…Œì´ë¸” ìˆ˜ (ì´ˆëŒ€ëŸ‰)
          TABLE_COUNT = 5000  
          OUTPUT_DIR = "oracle_sql"

          os.makedirs(OUTPUT_DIR, exist_ok=True)

          print(f"ğŸš€ {TABLE_COUNT}ê°œì˜ ì˜¤ë¼í´ í…Œì´ë¸” DDL ìƒì„± ì‹œì‘...")

          for i in range(1, TABLE_COUNT + 1):
              table_name = f"TB_BIG_DATA_{i:06d}"
              file_path = f"{OUTPUT_DIR}/{table_name}.sql"
              
              ddl = f"""
              -- Table: {table_name}
              -- Generated by OMTDG
              CREATE TABLE {table_name} (
                  ID NUMBER(19) NOT NULL,
                  TRX_DATE DATE DEFAULT SYSDATE,
                  DATA_PAYLOAD VARCHAR2(4000),
                  STATUS_CODE CHAR(2),
                  AMOUNT NUMBER(15,2),
                  CREATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP,
                  CONSTRAINT PK_{table_name} PRIMARY KEY (ID)
              ) TABLESPACE USERS NOLOGGING;

              CREATE INDEX IX_{table_name}_DATE ON {table_name}(TRX_DATE);
              COMMENT ON TABLE {table_name} IS 'Auto Generated Massive Table {i}';
              """
              
              with open(file_path, "w") as f:
                  f.write(ddl)

          print("âœ… ìƒì„± ì™„ë£Œ.")
          EOF
          
          # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          python generate_oracle_ddl.py

      # ---------------------------------------------------------
      # [2] Git ì„¤ì • ë° ëŒ€ëŸ‰ íŒŒì¼ ë¶„í•  ì»¤ë°‹ (ì—ëŸ¬ ìˆ˜ì •ë¨)
      # ---------------------------------------------------------
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Smart Batch Commit (Fixed Logic)
        shell: bash
        run: |
          # ë°°ì¹˜ ì‚¬ì´ì¦ˆ ì„¤ì • (í•œ ë²ˆì— 2000ê°œ)
          BATCH_SIZE=2000
          
          echo "ğŸ”µ ëŒ€ëŸ‰ íŒŒì¼ ì²˜ë¦¬ ì‹œì‘..."
          
          while true; do
            # 1. ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ì¡°íšŒ (ì„ì‹œ íŒŒì¼ batch_files.txt ì œì™¸)
            # git status --porcelainìœ¼ë¡œ ë³€ê²½ëœ íŒŒì¼ë§Œ ê°€ì ¸ì˜´
            git status --porcelain | grep -v "batch_files.txt" | head -n $BATCH_SIZE | awk '{print $2}' > batch_files.txt
            
            # 2. íŒŒì¼ì´ ì—†ìœ¼ë©´ ë£¨í”„ ì¢…ë£Œ
            if [ ! -s batch_files.txt ]; then
              echo "âœ… ë” ì´ìƒ ì»¤ë°‹í•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ì¢…ë£Œí•©ë‹ˆë‹¤."
              break
            fi
            
            # 3. íŒŒì¼ ê°œìˆ˜ í™•ì¸
            COUNT=$(wc -l < batch_files.txt)
            echo "ğŸš€ Processing batch of $COUNT files..."
            
            # 4. í•´ë‹¹ íŒŒì¼ë“¤ë§Œ Staging (xargs ì‚¬ìš©)
            cat batch_files.txt | xargs git add
            
            # 5. ì»¤ë°‹ (ì»¤ë°‹í•  ê²Œ ì—†ì–´ì„œ ì—ëŸ¬ë‚˜ëŠ” ìƒí™© ë°©ì§€)
            git commit -m "Auto-commit: Oracle Tables Batch ($COUNT files) [$(date +%T)]" || echo "âš ï¸ ì»¤ë°‹í•  ë‚´ìš© ì—†ìŒ (ê±´ë„ˆëœ€)"
            
            # (ì˜µì…˜) ì„ì‹œ íŒŒì¼ ì‚­ì œ (ë‹¤ìŒ ë£¨í”„ë¥¼ ìœ„í•´)
            rm batch_files.txt
          done

      # ---------------------------------------------------------
      # [3] ìµœì¢… í‘¸ì‹œ
      # ---------------------------------------------------------
      - name: Final Push
        if: success()
        run: |
          echo "ğŸ”µ GitHub ì €ì¥ì†Œë¡œ í‘¸ì‹œ ì¤‘..."
          # ì›ê²©ì§€ì™€ ì°¨ì´ê°€ ë°œìƒí–ˆì„ ê²½ìš° rebase í›„ push ì‹œë„
          git pull --rebase origin main
          git push origin HEAD:main
